<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPI AI Master - Arcade Edition</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SPI AI Master</h1>
            <div id="timerDisplay" class="timer-badge" style="display: none;">00:00</div>
        </div>

        <div class="quiz-container">
            <div class="quiz-setup" id="quizSetup">
                <div class="form-group">
                    <label for="quizGenre">出題ジャンル:</label>
                    <select id="quizGenre">
                        <option value="全般（言語・非言語バランスよく）">全般（言語・非言語）</option>
                        <option value="非言語（数学・推論）">非言語（数学・推論）</option>
                        <option value="言語（国語・語彙）">言語（国語・語彙）</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="questionCount">問題数:</label>
                    <input type="number" id="questionCount" min="1" max="10" value="5">
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <button class="btn" onclick="generateQuiz()">クイズを生成</button>
                </div>
            </div>

            <div class="quiz-playing" id="quizPlaying" style="display: none;">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                
                <div id="categoryTag" class="category-tag"></div>
                <div class="question" id="currentQuestion"></div>
                
                <ul class="selections" id="selections"></ul>
                
                <div class="answer-feedback" id="answerFeedback" style="display: none;">
                    <div id="feedbackStatus"></div>
                    <div id="explanationText" class="explanation-text"></div>
                </div>
                
                <div class="action-area" style="margin-top: 20px;">
                    <button class="btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">次の問題へ</button>
                    <button class="btn" id="finishBtn" onclick="showResults()" style="display: none;">結果を見る</button>
                    <button class="btn btn-outline" onclick="quitQuiz()" style="margin-top: 15px;">中断する</button>
                </div>
            </div>

            <div class="quiz-results" id="quizResults" style="display: none;">
                <div class="result-card">
                    <div id="rankBadge" class="rank-badge">RANK A</div>
                    <div class="score-display" id="finalScore"></div>
                    <div id="aiAdviceBox" class="ai-advice-box"></div>
                    <button class="btn" style="margin-top: 30px;" onclick="restartQuiz()">もう一度プレイ</button>
                </div>
            </div>
        </div>

        <div class="loading-overlay" id="loading">
            <div class="loader"></div>
            <p>AIがクエストを生成中...</p>
        </div>
    </div>

    <script>
        // JS部分は以前のロジックを継承
        let quizData = [];
        let aiAdvice = "";
        let currentQuestionIndex = 0;
        let score = 0;
        let hasAnswered = false;
        let startTime;
        let timerInterval;

        async function generateQuiz() {
            const genre = document.getElementById('quizGenre').value;
            const count = parseInt(document.getElementById('questionCount').value);
            document.getElementById('loading').style.display = 'flex';

            try {
                const response = await fetch('/api/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ genre, count, title: "SPI対策" })
                });
                const data = await response.json();
                quizData = data.questions;
                aiAdvice = data.advice;
                startQuiz();
            } catch (error) {
                alert("生成エラー！コンソールを確認してください。");
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function startQuiz() {
            document.getElementById('quizSetup').style.display = 'none';
            document.getElementById('quizPlaying').style.display = 'block';
            document.getElementById('timerDisplay').style.display = 'block';
            currentQuestionIndex = 0;
            score = 0;
            startTimer();
            showQuestion();
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - startTime) / 1000);
                const m = String(Math.floor(diff / 60)).padStart(2, '0');
                const s = String(diff % 60).padStart(2, '0');
                document.getElementById('timerDisplay').textContent = `${m}:${s}`;
            }, 1000);
        }

        function showQuestion() {
            const question = quizData[currentQuestionIndex];
            hasAnswered = false;
            const progress = ((currentQuestionIndex + 1) / quizData.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('categoryTag').textContent = question.category || 'SPI';
            document.getElementById('currentQuestion').textContent = question.question;
            const selectionsEl = document.getElementById('selections');
            selectionsEl.innerHTML = '';
            question.selections.forEach((selection, index) => {
                const li = document.createElement('li');
                li.className = 'selection-item';
                li.textContent = selection;
                li.onclick = () => selectAnswer(index);
                selectionsEl.appendChild(li);
            });
            document.getElementById('answerFeedback').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
        }

        function selectAnswer(index) {
            if (hasAnswered) return;
            hasAnswered = true;
            const question = quizData[currentQuestionIndex];
            const isCorrect = index === question.answer;
            if (isCorrect) score++;
            const items = document.querySelectorAll('.selection-item');
            items[question.answer].classList.add('correct');
            if (!isCorrect) items[index].classList.add('incorrect');
            document.getElementById('answerFeedback').style.display = 'block';
            document.getElementById('explanationText').textContent = question.explanation;
            if (currentQuestionIndex < quizData.length - 1) {
                document.getElementById('nextBtn').style.display = 'block';
            } else {
                document.getElementById('finishBtn').style.display = 'block';
                clearInterval(timerInterval);
            }
        }

        function nextQuestion() { currentQuestionIndex++; showQuestion(); }
        function quitQuiz() { if(confirm("中断しますか？")) location.reload(); }
        function restartQuiz() { location.reload(); }

        function showResults() {
            document.getElementById('quizPlaying').style.display = 'none';
            document.getElementById('quizResults').style.display = 'block';
            const percent = Math.round((score / quizData.length) * 100);
            document.getElementById('finalScore').innerHTML = `
                <p style="font-size:3rem; color:#5ee7ff; font-weight:bold;">${score} / ${quizData.length}</p>
                <p>正答率: ${percent}%</p>
            `;
            document.getElementById('aiAdviceBox').innerHTML = `<strong>AI ADVICE:</strong><br>${aiAdvice}`;
        }
    </script>
</body>
</html>